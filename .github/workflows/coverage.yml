name: Coverage (nix-bindings-sys)

on:
  push:
    branches: [ "main" ]
    paths:
      - 'nix-bindings-sys/**'
      - '.github/workflows/coverage.yml'
  pull_request:
    paths:
      - 'nix-bindings-sys/**'
      - '.github/workflows/coverage.yml'

jobs:
  coverage:
    name: Coverage Report (nix-bindings-sys)
    runs-on: ubuntu-latest

    env:
      CARGO_TERM_COLOR: always

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Install Nix
        uses: cachix/install-nix-action@master
        with:
          nix_path: nixpkgs=channel:nixos-25.11

      - name: Generate coverage report
        working-directory: nix-bindings-sys
        run: |
          eval "$(nix print-dev-env)"
          set -x

          cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v5
        with:
          name: coverage-lcov
          path: nix-bindings-sys/lcov.info

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: nix-bindings-sys/lcov.info
          flags: sys
          name: codecov-nix-bindings-sys
          fail_ci_if_error: false

      - name: Coverage summary
        working-directory: nix-bindings-sys
        run: |
          eval "$(nix print-dev-env)"
          set -x

          cargo llvm-cov report --all-features --workspace --summary-only

      - name: Check Nix header coverage
        working-directory: nix-bindings-sys
        run: |
          echo "## Nix Header Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This workflow measures how much of the Nix C API headers are covered by the generated Rust bindings and tests." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See the lcov.info artifact and Codecov for detailed results."
